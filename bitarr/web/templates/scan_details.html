{% extends 'layout.html' %}

{% block title %}Bitarr - Scan Details{% endblock %}

{% block content %}
<div class="scan-details">
    <div class="page-header">
        <h1>Scan Details</h1>
        <div class="actions">
            <button class="btn secondary" onclick="history.back()">Back to Scan History</button>
            <button class="btn primary rescan-btn" data-path="{{ scan.top_level_path }}">Rescan Path</button>
        </div>
    </div>

    <div class="details-panel">
        <div class="details-header">
            <h2>{{ scan.name or 'Scan of ' + scan.top_level_path }}</h2>
            <div class="scan-meta">
                <div class="meta-item">
                    <span class="meta-label">Date:</span>
                    <span class="meta-value time-ago" data-timestamp="{{ scan.start_time }}">{{ scan.start_time }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Status:</span>
                    <span class="meta-value">
                        {% if scan.status == 'completed' %}
                            {% if scan.files_corrupted > 0 %}
                                <span class="status-indicator status-critical"></span> Critical
                            {% elif scan.files_missing > 0 %}
                                <span class="status-indicator status-warning"></span> Warning
                            {% else %}
                                <span class="status-indicator status-good"></span> Good
                            {% endif %}
                        {% elif scan.status == 'running' %}
                            <span class="status-indicator status-running"></span> Running
                        {% elif scan.status == 'failed' %}
                            <span class="status-indicator status-critical"></span> Failed
                        {% else %}
                            <span class="status-indicator status-warning"></span> {{ scan.status|title }}
                        {% endif %}
                    </span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Duration:</span>
                    <span class="meta-value">
                        {% if scan.end_time %}
                            Duration calculated
                        {% else %}
                            In progress
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div class="pie-chart-container">
                <canvas id="fileStatusChart" width="180" height="180"></canvas>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color unchanged-color"></div>
                        <div>{{ scan.files_unchanged|default(0)|thousands_separator }} Unchanged ({% if scan.files_scanned and scan.files_scanned > 0 %}{{ ((scan.files_unchanged|default(0) / scan.files_scanned) * 100)|round(1) }}%{% else %}0%{% endif %})</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color modified-color"></div>
                        <div>{{ scan.files_modified|default(0)|thousands_separator }} Modified ({% if scan.files_scanned and scan.files_scanned > 0 %}{{ ((scan.files_modified|default(0) / scan.files_scanned) * 100)|round(1) }}%{% else %}0%{% endif %})</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color corrupted-color"></div>
                        <div>{{ scan.files_corrupted|default(0)|thousands_separator }} Corrupted ({% if scan.files_scanned and scan.files_scanned > 0 %}{{ ((scan.files_corrupted|default(0) / scan.files_scanned) * 100)|round(1) }}%{% else %}0%{% endif %})</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color missing-color"></div>
                        <div>{{ scan.files_missing|default(0)|thousands_separator }} Missing ({% if scan.files_scanned and scan.files_scanned > 0 %}{{ ((scan.files_missing|default(0) / scan.files_scanned) * 100)|round(1) }}%{% else %}0%{% endif %})</div>
                    </div>
                    {% if scan.files_new %}
                    <div class="legend-item">
                        <div class="legend-color new-color"></div>
                        <div>{{ scan.files_new|thousands_separator }} New ({% if scan.files_scanned and scan.files_scanned > 0 %}{{ ((scan.files_new / scan.files_scanned) * 100)|round(1) }}%{% else %}0%{% endif %})</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="scan-summary">
                <h3>Scan Summary</h3>

                {% if scan.files_corrupted > 0 or scan.files_missing > 0 %}
                    <p>This scan detected <strong>{{ scan.files_corrupted }} potentially corrupted files</strong> and <strong>{{ scan.files_missing }} missing files</strong> compared to previous scans.</p>

                    {% if summary and summary.corruption_by_directory %}
                        <p>Most corruption was found in the <code>{{ summary.corruption_by_directory[0].directory }}</code> directory.</p>
                    {% endif %}
                {% else %}
                    <p>No file corruption or missing files detected in this scan.</p>
                {% endif %}

                {% if summary and summary.storage_devices %}
                    <p><strong>Storage Devices Involved:</strong> {{ summary.storage_devices|length }} devices detected in this scan:</p>
                    <ul class="device-list">
                        {% for device in summary.storage_devices %}
                            <li>
                                <strong>{{ device.name }}</strong> -
                                {% if device.corrupted_files %}{{ device.corrupted_files }}{% else %}0{% endif %} corrupted files,
                                {% if device.missing_files %}{{ device.missing_files }}{% else %}0{% endif %} missing files
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                <p>
                    The scan was completed in
                    {% if scan.end_time %}
                        Duration calculated
                    {% else %}
                        (in progress)
                    {% endif %}.
                    Total space occupied by scanned files: {{ summary.total_size|default(0)|format_size }}.
                </p>

                {% if scan.error_message %}
                    <div class="error-message">
                        <h4>Error Message</h4>
                        <p>{{ scan.error_message }}</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" data-tab="all-files">All Files</button>
            {% if scan.files_corrupted > 0 %}
                <button class="tab-button" data-tab="corrupted-files">Corrupted Files</button>
            {% endif %}
            {% if scan.files_missing > 0 %}
                <button class="tab-button" data-tab="missing-files">Missing Files</button>
            {% endif %}
            {% if scan.files_modified > 0 %}
                <button class="tab-button" data-tab="modified-files">Modified Files</button>
            {% endif %}
            {% if errors %}
                <button class="tab-button" data-tab="errors">Errors ({{ errors|length }})</button>
            {% endif %}
        </div>

        <div class="tab-content" id="all-files">
            <div class="controls">
                <div class="search-container">
                    <input type="text" class="search-filter" placeholder="Filter files...">
                </div>
                <div class="filter-buttons">
                    <button class="btn small secondary filter-btn" data-filter="all">All</button>
                    <button class="btn small secondary filter-btn" data-filter="corrupted">Corrupted</button>
                    <button class="btn small secondary filter-btn" data-filter="missing">Missing</button>
                    <button class="btn small secondary filter-btn" data-filter="modified">Modified</button>
                    <button class="btn small secondary filter-btn" data-filter="unchanged">Unchanged</button>
                </div>
            </div>

            <div class="table-container files-table">
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Path / Filename</th>
                            <th>Storage Device</th>
                            <th>Size</th>
                            <th>Last Modified</th>
                            <th>Checksum</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if summary.files %}
                            {% for file in summary.files %}
                                <tr class="file-row {{ file.status }}-row">
                                    <td>
                                        {% if file.status == 'corrupted' %}
                                            <span class="status-indicator status-critical"></span> Corrupted
                                        {% elif file.status == 'missing' %}
                                            <span class="status-indicator status-warning"></span> Missing
                                        {% elif file.status == 'modified' %}
                                            <span class="status-indicator status-good"></span> Modified
                                        {% elif file.status == 'unchanged' %}
                                            <span class="status-indicator status-good"></span> Unchanged
                                        {% elif file.status == 'new' %}
                                            <span class="status-indicator status-good"></span> New
                                        {% endif %}
                                    </td>
                                    <td class="file-path">{{ file.path }}</td>
                                    <td>{{ file.device_name }}</td>
                                    <td class="file-size" data-size="{{ file.size }}">
                                        {{ file.size|format_size }}
                                    </td>
                                    <td class="time-ago" data-timestamp="{{ file.last_modified }}">
                                        {{ file.last_modified }}
                                    </td>
                                    <td class="checksum">
                                        <span class="monospace">{{ file.checksum_value[:10] }}...</span>
                                        {% if file.status == 'corrupted' %}
                                            <br>
                                            <span class="monospace previous">(was: {{ file.previous_checksum[:10] }}...)</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="no-data">File details not available</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <div class="pagination-controls">
                <div class="page-info">
                    Showing <span id="showingStart">1</span>-<span id="showingEnd">{{ summary.files|default([])|length }}</span> of <span id="totalFiles">{{ scan.files_scanned }}</span> files
                </div>
                <div>
                    <button id="loadMoreBtn" class="btn secondary">Load More Files</button>
                </div>
            </div>
        </div>

        {% if scan.files_corrupted > 0 %}
            <div class="tab-content" id="corrupted-files" style="display: none;">
                <div class="table-container files-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Path / Filename</th>
                                <th>Storage Device</th>
                                <th>Size</th>
                                <th>Last Modified</th>
                                <th>Current Checksum</th>
                                <th>Previous Checksum</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if summary.files %}
                                {% for file in summary.files if file.status == 'corrupted' %}
                                    <tr>
                                        <td class="file-path">{{ file.path }}</td>
                                        <td>{{ file.device_name }}</td>
                                        <td class="file-size" data-size="{{ file.size }}">
                                            {{ file.size|format_size }}
                                        </td>
                                        <td class="time-ago" data-timestamp="{{ file.last_modified }}">
                                            {{ file.last_modified }}
                                        </td>
                                        <td class="checksum monospace">{{ file.checksum_value }}</td>
                                        <td class="checksum monospace">{{ file.previous_checksum }}</td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="no-data">No corrupted files found</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="no-data">File details not available</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}

        {% if scan.files_missing > 0 %}
            <div class="tab-content" id="missing-files" style="display: none;">
                <div class="table-container files-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Path / Filename</th>
                                <th>Storage Device</th>
                                <th>Last Known Size</th>
                                <th>Last Modified</th>
                                <th>Previous Checksum</th>
                                <th>Last Seen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if summary.files %}
                                {% for file in summary.files if file.status == 'missing' %}
                                    <tr>
                                        <td class="file-path">{{ file.path }}</td>
                                        <td>{{ file.device_name }}</td>
                                        <td class="file-size" data-size="{{ file.size }}">
                                            {{ file.size|format_size }}
                                        </td>
                                        <td class="time-ago" data-timestamp="{{ file.last_modified }}">
                                            {{ file.last_modified }}
                                        </td>
                                        <td class="checksum monospace">{{ file.previous_checksum }}</td>
                                        <td class="time-ago" data-timestamp="{{ file.last_seen }}">
                                            {{ file.last_seen }}
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="no-data">No missing files found</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="no-data">File details not available</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}

        {% if scan.files_modified > 0 %}
            <div class="tab-content" id="modified-files" style="display: none;">
                <div class="table-container files-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Path / Filename</th>
                                <th>Storage Device</th>
                                <th>Size</th>
                                <th>Last Modified</th>
                                <th>Current Checksum</th>
                                <th>Previous Checksum</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if summary.files %}
                                {% for file in summary.files if file.status == 'modified' %}
                                    <tr>
                                        <td class="file-path">{{ file.path }}</td>
                                        <td>{{ file.device_name }}</td>
                                        <td class="file-size" data-size="{{ file.size }}">
                                            {{ file.size|format_size }}
                                        </td>
                                        <td class="time-ago" data-timestamp="{{ file.last_modified }}">
                                            {{ file.last_modified }}
                                        </td>
                                        <td class="checksum monospace">{{ file.checksum_value }}</td>
                                        <td class="checksum monospace">{{ file.previous_checksum }}</td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="no-data">No modified files found</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="no-data">File details not available</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}

        {% if errors %}
            <div class="tab-content" id="errors" style="display: none;">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>File Path</th>
                                <th>Error Type</th>
                                <th>Error Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for error in errors %}
                                <tr>
                                    <td class="time-ago" data-timestamp="{{ error.timestamp }}">
                                        {{ error.timestamp }}
                                    </td>
                                    <td class="file-path">{{ error.file_path }}</td>
                                    <td>{{ error.error_type }}</td>
                                    <td>{{ error.error_message }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}

        <div class="actions">
            <button class="btn secondary" id="exportReportBtn">Export Report</button>
            <button class="btn primary rescan-btn" data-path="{{ scan.top_level_path }}">Rescan This Path</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Create pie chart for file status
        initializeFileStatusChart();

        // Handle tab switching
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                tabButtons.forEach(btn => btn.classList.remove('active'));

                // Add active class to clicked button
                this.classList.add('active');

                // Hide all tab contents
                tabContents.forEach(content => content.style.display = 'none');

                // Show the selected tab content
                const tabId = this.dataset.tab;
                document.getElementById(tabId).style.display = 'block';
            });
        });

        // Handle file filtering
        const fileSearchFilter = document.querySelector('.search-filter');
        const fileRows = document.querySelectorAll('.file-row');

        if (fileSearchFilter) {
            fileSearchFilter.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();

                fileRows.forEach(row => {
                    const filePath = row.querySelector('.file-path').textContent.toLowerCase();

                    if (filePath.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Update pagination info
                updateFilesPaginationInfo();
            });
        }

        // Handle filter buttons
        const filterButtons = document.querySelectorAll('.filter-btn');

        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                const filter = this.dataset.filter;

                // Remove active class from all filter buttons
                filterButtons.forEach(btn => btn.classList.remove('active'));

                // Add active class to clicked button
                this.classList.add('active');

                if (filter === 'all') {
                    // Show all rows
                    fileRows.forEach(row => row.style.display = '');
                } else {
                    // Show only rows with the selected status
                    fileRows.forEach(row => {
                        if (row.classList.contains(`${filter}-row`)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                }

                // Update pagination info
                updateFilesPaginationInfo();
            });
        });

        // Handle rescan buttons
        const rescanButtons = document.querySelectorAll('.rescan-btn');

        rescanButtons.forEach(button => {
            button.addEventListener('click', function() {
                const path = this.dataset.path;

                // Open new scan modal with path pre-filled
                const newScanModal = document.getElementById('newScanModal');
                const scanPathInput = document.getElementById('scanPath');

                if (newScanModal && scanPathInput) {
                    scanPathInput.value = path;
                    openModal(newScanModal);
                }
            });
        });

        // Handle export report button
        const exportReportBtn = document.getElementById('exportReportBtn');

        if (exportReportBtn) {
            exportReportBtn.addEventListener('click', function() {
                // TODO: Implement report export
                alert('Export functionality will be implemented in a future update.');
            });
        }

        // Handle loading more files
        const loadMoreBtn = document.getElementById('loadMoreBtn');

        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', function() {
                // TODO: Implement loading more files

                // For now, just show a message
                alert('Loading more files will be implemented in a future update.');
            });
        }

        // Helper function to update files pagination info
        function updateFilesPaginationInfo() {
            const showingStart = document.getElementById('showingStart');
            const showingEnd = document.getElementById('showingEnd');
            const totalFiles = document.getElementById('totalFiles');

            if (showingStart && showingEnd && totalFiles) {
                const visibleRows = document.querySelectorAll('.file-row:not([style*="display: none"])');
                showingStart.textContent = visibleRows.length > 0 ? 1 : 0;
                showingEnd.textContent = visibleRows.length;
                // Keep total the same
            }
        }

        // Helper function to open a modal
        function openModal(modal) {
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        // Function to initialize file status chart
        function initializeFileStatusChart() {
            const ctx = document.getElementById('fileStatusChart');
            if (!ctx) return;

            // Set canvas size constraints
            ctx.width = 200;
            ctx.height = 200;
            ctx.style.maxWidth = '200px';
            ctx.style.maxHeight = '200px';

            // Get chart data from the template
            const unchangedCount = {{ scan.files_unchanged|default(0) }};
            const modifiedCount = {{ scan.files_modified|default(0) }};
            const corruptedCount = {{ scan.files_corrupted|default(0) }};
            const missingCount = {{ scan.files_missing|default(0) }};
            const newCount = {{ scan.files_new|default(0) }};

            console.log('DEBUG: Chart data:', {unchangedCount, modifiedCount, corruptedCount, missingCount, newCount});

            // Create data array (exclude categories with 0 count)
            const labels = [];
            const data = [];
            const backgroundColor = [];

            if (unchangedCount > 0) {
                labels.push('Unchanged');
                data.push(unchangedCount);
                backgroundColor.push('#28a745');
            }

            if (modifiedCount > 0) {
                labels.push('Modified');
                data.push(modifiedCount);
                backgroundColor.push('#1565c0');
            }

            if (corruptedCount > 0) {
                labels.push('Corrupted');
                data.push(corruptedCount);
                backgroundColor.push('#c62828');
            }

            if (missingCount > 0) {
                labels.push('Missing');
                data.push(missingCount);
                backgroundColor.push('#616161');
            }

            if (newCount > 0) {
                labels.push('New');
                data.push(newCount);
                backgroundColor.push('#00838f');
            }

            // CRITICAL FIX: If no data, don't create chart
            if (data.length === 0 || data.every(value => value === 0)) {
                console.log('DEBUG: No chart data available, hiding chart');
                const chartContainer = document.querySelector('.pie-chart-container');
                if (chartContainer) {
                    chartContainer.style.display = 'none';
                }
                return;
            }

            console.log('DEBUG: Creating chart with data:', {labels, data});

            // Create the chart with fixed options
            try {
                new Chart(ctx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColor,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        cutout: '50%',
                        animation: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        responsive: false,
                        maintainAspectRatio: false,
                        aspectRatio: 1,
                        layout: {
                            padding: 10
                        }
                    }
                });
            } catch (error) {
                console.error('Chart creation failed:', error);
                const chartContainer = document.querySelector('.pie-chart-container');
                if (chartContainer) {
                    chartContainer.style.display = 'none';
                }
            }
        }
    });
</script>
{% endblock %}
