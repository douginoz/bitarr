{% extends 'layout.html' %}

{% block title %}Bitarr - Scan Results{% endblock %}

{% block content %}
<div class="scan-details">
    <!-- Page Header with Key Info -->
    <div class="scan-header">
        <h1>Scan Results</h1>
        <h2>
            {% if scan.name %}
                {{ scan.name }} on {{ scan.host_display_name }}
            {% else %}
                {{ scan.top_level_path }} on {{ scan.host_display_name }}
            {% endif %}
        </h2>

        <!-- Quick Stats Bar -->
        <div class="quick-stats">
            <span class="stat-item">
                üìÖ {{ scan.start_time|strftime('%Y-%m-%d %H:%M') }}
            </span>
            <span class="stat-item">
                üìä {{ (scan.files_scanned if scan.files_scanned > 0 else scan.files_unchanged if scan.files_unchanged else 0)|thousands_separator }} files
            </span>
            {% if scan.total_size and scan.total_size > 0 %}
            <span class="stat-item">
                üíæ {{ scan.total_size|format_size }}
            </span>
            {% endif %}
            <span class="stat-item">
                {% set duration = scan.start_time|duration_seconds(scan.end_time) %}
                {% if duration %}
                    ‚è±Ô∏è {{ duration|round(1) }}s
                {% else %}
                    ‚è±Ô∏è Unknown duration
                {% endif %}
            </span>
        </div>
    </div>

    <!-- Critical Issues First (if any) -->
    {% if scan.files_corrupted > 0 or scan.files_missing > 0 or summary.error_count > 0 %}
    <div class="critical-issues">
        {% if scan.files_corrupted > 0 %}
            <div class="issue-block critical">
                <h3>üö® {{ scan.files_corrupted }} Corrupted Files Detected</h3>
                <p>These files have changed checksums without modification time changes, indicating possible bitrot.</p>
                <!-- Show corrupted files immediately here -->
            </div>
        {% endif %}

        {% if scan.files_missing > 0 %}
            <div class="issue-block warning">
                <h3>‚ö†Ô∏è {{ scan.files_missing }} Missing Files</h3>
                <p>Files that were previously scanned are no longer found.</p>
                <!-- Show missing files immediately here -->
            </div>
        {% endif %}

        {% if summary.error_count > 0 %}
            <div class="issue-block warning">
                <h3>‚ö†Ô∏è {{ summary.error_count }} Scan Errors</h3>
                <p>Files that could not be scanned due to I/O errors, permissions, or hardware issues.</p>

                <!-- Show error details immediately -->
                <div class="error-details">
                    <table class="error-table">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Issue</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for error in errors %}
                            <tr>
                                <td class="file-path">{{ error.file_path|truncate(60) }}</td>
                                <td>
                                    <span class="error-type">
                                        {% if error.error_type == 'checksum_error' %}
                                            Read Error
                                        {% elif error.error_type == 'processing_error' %}
                                            Processing Error
                                        {% else %}
                                            {{ error.error_type|title }}
                                        {% endif %}
                                    </span>
                                </td>
                                <td class="error-message">{{ error.error_message|truncate(80) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Results Summary (Compact) -->
    <div class="results-summary">
        {% if scan.files_corrupted > 0 or scan.files_missing > 0 or summary.error_count > 0 %}
            <!-- Issues detected - show action-oriented summary -->
            <div class="summary-alert critical">
                <h3>‚ö†Ô∏è Issues Require Attention</h3>
                <div class="summary-stats">
                    {% if scan.files_corrupted > 0 %}<span class="stat critical">{{ scan.files_corrupted }} corrupted</span>{% endif %}
                    {% if scan.files_missing > 0 %}<span class="stat warning">{{ scan.files_missing }} missing</span>{% endif %}
                    {% if summary.error_count > 0 %}<span class="stat error">{{ summary.error_count }} errors</span>{% endif %}
                    {% if scan.files_unchanged > 0 %}<span class="stat good">{{ scan.files_unchanged }} verified</span>{% endif %}
                </div>
            </div>
        {% elif scan.files_modified > 0 or scan.files_new > 0 %}
            <!-- Changes detected - show what changed -->
            <div class="summary-alert info">
                <h3>üìã Changes Detected</h3>
                <div class="summary-stats">
                    {% if scan.files_new > 0 %}<span class="stat new">{{ scan.files_new }} new</span>{% endif %}
                    {% if scan.files_modified > 0 %}<span class="stat modified">{{ scan.files_modified }} modified</span>{% endif %}
                    {% if scan.files_unchanged > 0 %}<span class="stat good">{{ scan.files_unchanged }} unchanged</span>{% endif %}
                </div>
            </div>
        {% elif scan.files_unchanged > 0 %}
            <!-- All good - simple confirmation -->
            <div class="summary-alert success">
                <h3>‚úÖ All Files Verified</h3>
                <p>{{ scan.files_unchanged }} files verified unchanged from previous scan.</p>
            </div>
        {% else %}
            <!-- Initial scan -->
            <div class="summary-alert info">
                <h3>üìã Initial Scan Complete</h3>
                <p>{{ scan.files_new if scan.files_new > 0 else 'Files' }} catalogued for future integrity monitoring.</p>
            </div>
        {% endif %}
    </div>

    <!-- Scan Details (Collapsible) -->
    <details class="scan-details-section">
        <summary class="details-toggle">
            <h3>üìã Scan Details</h3>
        </summary>
        <div class="details-content">
            <div class="detail-grid">
                <div class="detail-item">
                    <label>Host:</label>
                    <span>{{ scan.host_display_name }}</span>
                </div>
                <div class="detail-item">
                    <label>Path:</label>
                    <span>{{ scan.top_level_path }}</span>
                </div>
                <div class="detail-item">
                    <label>Checksum Method:</label>
                    <span>{{ scan.checksum_method|upper }}</span>
                </div>
                <div class="detail-item">
                    <label>Storage Device:</label>
                    <span>
                        {% if summary.storage_devices %}
                            {{ summary.storage_devices[0].name }}
                        {% else %}
                            Unknown
                        {% endif %}
                    </span>
                </div>
                <div class="detail-item">
                    <label>Status:</label>
                    <span>
                        {% if scan.status == 'completed' %}
                            <span class="badge success">Completed</span>
                        {% elif scan.status == 'running' %}
                            <span class="badge info">Running</span>
                        {% elif scan.status == 'failed' %}
                            <span class="badge error">Failed</span>
                        {% else %}
                            <span class="badge secondary">{{ scan.status|title }}</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </details>

    <!-- File Listing (Future) -->
    <details class="file-listing-section">
        <summary class="details-toggle">
            <h3>üìÅ File Listing (Coming Soon)</h3>
        </summary>
        <div class="details-content">
            <div class="file-listing-placeholder">
                <p>Paginated file listing with search and filtering capabilities.</p>
                <p>Will show individual file status, checksums, and details.</p>
            </div>
        </div>
    </details>

    <!-- Actions -->
    <div class="scan-actions">
        <button class="btn secondary" onclick="history.back()">‚Üê Back to History</button>
        <button class="btn primary rescan-btn" data-path="{{ scan.top_level_path }}">Rescan Path</button>
        {% if summary.error_count > 0 or scan.files_corrupted > 0 %}
            <button class="btn warning" onclick="alert('Storage diagnostics feature coming soon.')">
                üîß Run Storage Diagnostics
            </button>
        {% endif %}
    </div>
</div>

<style>
.scan-header {
    margin-bottom: 30px;
}

.scan-header h1 {
    margin-bottom: 5px;
    color: #333;
}

.scan-header h2 {
    margin-bottom: 15px;
    color: #666;
    font-size: 1.3em;
}

.quick-stats {
    display: flex;
    gap: 20px;
    font-size: 14px;
    color: #666;
    flex-wrap: wrap;
}

.critical-issues {
    margin-bottom: 30px;
}

.issue-block {
    margin-bottom: 20px;
    padding: 20px;
    border-radius: 8px;
    border-left: 5px solid;
}

.issue-block.critical {
    background: #f8d7da;
    border-left-color: #dc3545;
}

.issue-block.warning {
    background: #fff3cd;
    border-left-color: #ffc107;
}

.issue-block h3 {
    margin: 0 0 10px 0;
    color: #721c24;
}

.issue-block.warning h3 {
    color: #856404;
}

.error-details {
    margin-top: 15px;
}

.error-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.error-table th,
.error-table td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.error-table th {
    background: #f8f9fa;
    font-weight: bold;
}

.error-type {
    background: #ffc107;
    color: #856404;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.results-summary {
    margin-bottom: 30px;
}

.summary-alert {
    padding: 20px;
    border-radius: 8px;
    border-left: 5px solid;
}

.summary-alert.success {
    background: #d4edda;
    border-left-color: #28a745;
}

.summary-alert.info {
    background: #d1ecf1;
    border-left-color: #17a2b8;
}

.summary-alert.critical {
    background: #f8d7da;
    border-left-color: #dc3545;
}

.summary-stats {
    display: flex;
    gap: 15px;
    margin-top: 10px;
    flex-wrap: wrap;
}

.summary-stats .stat {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: bold;
}

.stat.good {
    background: #d4edda;
    color: #155724;
}

.stat.new {
    background: #e2e3e5;
    color: #495057;
}

.stat.modified {
    background: #d1ecf1;
    color: #0c5460;
}

.stat.critical {
    background: #f8d7da;
    color: #721c24;
}

.stat.warning {
    background: #fff3cd;
    color: #856404;
}

.stat.error {
    background: #f8d7da;
    color: #721c24;
}

.scan-details-section,
.file-listing-section {
    margin-bottom: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
}

.details-toggle {
    padding: 15px 20px;
    background: #f8f9fa;
    cursor: pointer;
    border-radius: 8px 8px 0 0;
}

.details-toggle h3 {
    margin: 0;
    display: inline;
}

.details-content {
    padding: 20px;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.detail-item label {
    font-weight: bold;
    color: #555;
}

.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.badge.success {
    background: #d4edda;
    color: #155724;
}

.badge.info {
    background: #d1ecf1;
    color: #0c5460;
}

.badge.error {
    background: #f8d7da;
    color: #721c24;
}

.badge.secondary {
    background: #e2e3e5;
    color: #495057;
}

.scan-actions {
    margin-top: 30px;
    text-align: center;
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

.file-listing-placeholder {
    text-align: center;
    padding: 40px;
    color: #666;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle rescan buttons
    const rescanButtons = document.querySelectorAll('.rescan-btn');
    rescanButtons.forEach(button => {
        button.addEventListener('click', function() {
            const path = this.dataset.path;
            alert('Starting new scan for: ' + path);
        });
    });
});
</script>
{% endblock %}
